# ================================
# nftables default-drop firewall
# ================================
# Policy: default deny on input, forward, output.
# Egress allowed: DNS (53/udp, 53/tcp), HTTP (80/tcp), HTTPS (443/tcp).
# Ingress allowed: SSH (22/tcp).
# Stateful replies are permitted.
# SYN|FIN packets are logged and dropped.
# Per-chain counters record packets and bytes.

table inet firewall {
    # ---------
    # Variables
    # ---------
    define DNS_PORT = 53
    define HTTP_PORT = 80
    define HTTPS_PORT = 443
    define SSH_PORT = 22

    # -----
    # INPUT
    # -----
    chain input {
        type filter hook input priority 0; policy drop;

        # Count every packet that hits INPUT
        counter comment "INPUT counter"

        # Always allow loopback
        iif lo accept

        # Drop suspicious TCP scans (SYN|FIN)
        tcp flags & (syn|fin) == (syn|fin) log prefix "SYN-FIN in:" counter drop

        # Permit established and related return traffic
        ct state { established, related } accept

        # Allow incoming DNS to this host (UDP and TCP)
        meta 14proto udp udp dport $DNS_PORT ct state { new, established } accept
        meta 14proto tcp tcp dport $DNS_PORT ct state { new, established } accept

        # Allow incoming SSH
        tcp dport $SSH_PORT ct state new accept
    }

    # ---------
    # FORWARD
    # ---------
    chain forward {
        type filter hook forward priority 0; policy drop;

        # Count every packet that hits FORWARD
        counter comment "FORWARD counter"

        # Drop suspicious TCP scans (SYN|FIN) transiting the host
        tcp flags & (syn|fin) == (syn|fin) log prefix "SYN-FIN fwd:" counter drop

        # Permit established and related return traffic
        ct state { established, related } accept

        # No new forwarded sessions are permitted
    }

    # -------
    # OUTPUT
    # -------
    chain output {
        type filter hook output priority 0; policy drop;

        # Count every packet that hits OUTPUT
        counter comment "OUTPUT counter"

        # Always allow loopback
        oif lo accept

        # Permit replies to sessions we created
        ct state { established, related } accept

        # Allow DNS queries (UDP and TCP)
        meta 14proto udp udp dport $DNS_PORT ct state new accept
        meta 14proto tcp tcp dport $DNS_PORT ct state new accept

        # Allow HTTP and HTTPS
        tcp dport { $HTTP_PORT, $HTTPS_PORT } ct state new accept
    }
}
